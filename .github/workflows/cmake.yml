name: CI

"on":
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"
  workflow_dispatch:

env:
  BUILD_TYPE: Debug
  VSOMEIP_PREFIX: /opt/vsomeip
  ICEORYX_PREFIX: /opt/iceoryx
  CYCLONEDDS_PREFIX: /opt/cyclonedds

jobs:
  full-feature-test:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    - uses: actions/checkout@v4

    - name: Install system dependencies (repo script)
      run: |
        set -euxo pipefail
        ./scripts/install_dependency.sh

    - name: Build and install middleware dependencies (repo scripts)
      env:
        VSOMEIP_PREFIX: ${{ env.VSOMEIP_PREFIX }}
        ICEORYX_PREFIX: ${{ env.ICEORYX_PREFIX }}
        CYCLONEDDS_PREFIX: ${{ env.CYCLONEDDS_PREFIX }}
      run: |
        set -euxo pipefail
        ./scripts/install_middleware_stack.sh \
          --vsomeip-prefix "${VSOMEIP_PREFIX}" \
          --iceoryx-prefix "${ICEORYX_PREFIX}" \
          --cyclonedds-prefix "${CYCLONEDDS_PREFIX}" \
          --skip-system-deps

        sudo ldconfig

    - name: Configure CMake (all backends)
      env:
        VSOMEIP_PREFIX: ${{ env.VSOMEIP_PREFIX }}
        ICEORYX_PREFIX: ${{ env.ICEORYX_PREFIX }}
        CYCLONEDDS_PREFIX: ${{ env.CYCLONEDDS_PREFIX }}
      run: |
        set -euxo pipefail
        cmake -S "${GITHUB_WORKSPACE}" -B "${GITHUB_WORKSPACE}/build" \
          -DCMAKE_BUILD_TYPE="${BUILD_TYPE}" \
          -Dbuild_tests=ON \
          -DARA_COM_USE_VSOMEIP=ON \
          -DARA_COM_USE_ICEORYX=ON \
          -DARA_COM_USE_CYCLONEDDS=ON \
          -DARA_COM_ENABLE_ARXML_CODEGEN=ON \
          -DAUTOSAR_AP_BUILD_SAMPLES=OFF \
          -DVSOMEIP_PREFIX="${VSOMEIP_PREFIX}" \
          -DICEORYX_PREFIX="${ICEORYX_PREFIX}" \
          -DCYCLONEDDS_PREFIX="${CYCLONEDDS_PREFIX}"

    - name: Build
      run: |
        set -euxo pipefail
        cmake --build "${GITHUB_WORKSPACE}/build" --config "${BUILD_TYPE}" -j"$(nproc)"

    - name: Run unit tests
      env:
        LD_LIBRARY_PATH: /opt/vsomeip/lib:/opt/cyclonedds/lib:/opt/iceoryx/lib
      run: |
        set -euxo pipefail
        ctest --test-dir "${GITHUB_WORKSPACE}/build" --output-on-failure -C "${BUILD_TYPE}"

    - name: Run ARXML generator checks
      run: |
        set -euxo pipefail
        python3 tools/arxml_generator/generate_arxml.py \
          --input tools/arxml_generator/examples/pubsub_vsomeip.yaml \
          --output /tmp/ci_pubsub_vsomeip.arxml \
          --overwrite \
          --print-summary

        python3 tools/arxml_generator/generate_arxml.py \
          --input tools/arxml_generator/examples/pubsub_multi_transport.yaml \
          --output /tmp/ci_pubsub_multi_transport.arxml \
          --allow-extensions \
          --overwrite \
          --print-summary

        python3 tools/arxml_generator/generate_ara_com_binding.py \
          --input /tmp/ci_pubsub_vsomeip.arxml \
          --output /tmp/ci_vehicle_status_manifest_binding.h \
          --namespace sample::vehicle_status::generated \
          --provided-service-short-name VehicleStatusProviderInstance \
          --provided-event-group-short-name VehicleStatusEventGroup

        test -s /tmp/ci_pubsub_vsomeip.arxml
        test -s /tmp/ci_pubsub_multi_transport.arxml
        test -s /tmp/ci_vehicle_status_manifest_binding.h

    - name: Validate install split and user app build
      env:
        LD_LIBRARY_PATH: /opt/vsomeip/lib:/opt/cyclonedds/lib:/opt/iceoryx/lib
      run: |
        set -euxo pipefail
        ./scripts/build_and_install_autosar_ap.sh \
          --prefix /tmp/autosar_ap \
          --build-dir build-install-ci \
          --build-type Release \
          --source-dir "${GITHUB_WORKSPACE}" \
          --with-platform-app

        ./scripts/build_user_apps_from_opt.sh \
          --prefix /tmp/autosar_ap \
          --source-dir /tmp/autosar_ap/user_apps \
          --build-dir build-user-apps-ci

        ./scripts/build_user_apps_from_opt.sh \
          --prefix /tmp/autosar_ap \
          --source-dir /tmp/autosar_ap/user_apps \
          --build-dir build-user-apps-ci-run \
          --run

    - name: Verify Raspberry Pi ECU profile (mock CAN)
      env:
        LD_LIBRARY_PATH: /opt/vsomeip/lib:/opt/cyclonedds/lib:/opt/iceoryx/lib
      run: |
        set -euxo pipefail
        ./scripts/verify_rpi_ecu_profile.sh \
          --prefix /tmp/autosar_ap \
          --user-app-build-dir "${GITHUB_WORKSPACE}/build-user-apps-ci" \
          --can-backend mock \
          --require-platform-binary

  docs:
    runs-on: ubuntu-22.04
    needs: full-feature-test
    steps:
    - uses: actions/checkout@v4

    - name: Install Doxygen
      run: |
        set -euxo pipefail
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends doxygen graphviz

    - name: Generate API documentation
      run: |
        set -euxo pipefail
        ./scripts/generate_doxygen_docs.sh
        test -s docs/api/index.html
        test -s docs/index.html
        test -s docs/simulation_flow_diagram.png

    - name: Upload documentation artifact
      uses: actions/upload-artifact@v4
      with:
        name: doxygen-html
        path: docs
        if-no-files-found: error

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: docs

  deploy-pages:
    runs-on: ubuntu-22.04
    needs: docs
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      pages: write
      id-token: write
      contents: read
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
    - name: Configure GitHub Pages
      uses: actions/configure-pages@v5

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
