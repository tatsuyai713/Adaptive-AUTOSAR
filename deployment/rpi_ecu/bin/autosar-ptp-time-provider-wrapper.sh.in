#!/usr/bin/env bash
set -euo pipefail

DEFAULT_AUTOSAR_AP_PREFIX="__AUTOSAR_AP_PREFIX__"
DEFAULT_ENV_FILE="/etc/default/autosar-ptp-time-provider"

if [[ -f "${DEFAULT_ENV_FILE}" ]]; then
  # shellcheck disable=SC1090
  source "${DEFAULT_ENV_FILE}"
fi

: "${AUTOSAR_AP_PREFIX:=${DEFAULT_AUTOSAR_AP_PREFIX}}"
: "${AUTOSAR_PTP_BIN:=${AUTOSAR_AP_PREFIX}/bin/autosar_ptp_time_provider}"

if [[ ! -x "${AUTOSAR_PTP_BIN}" ]]; then
  echo "[ERROR] PTP time provider binary not found: ${AUTOSAR_PTP_BIN}" >&2
  exit 1
fi

extra_libdirs=""
for candidate in \
  "${AUTOSAR_AP_PREFIX}/lib" \
  "${AUTOSAR_AP_PREFIX}/lib64"; do
  if [[ -d "${candidate}" ]]; then
    if [[ -n "${extra_libdirs}" ]]; then
      extra_libdirs="${extra_libdirs}:"
    fi
    extra_libdirs="${extra_libdirs}${candidate}"
  fi
done
export LD_LIBRARY_PATH="${extra_libdirs}:${LD_LIBRARY_PATH:-}"

exec "${AUTOSAR_PTP_BIN}" "$@"
